# ロボット自動追跡システム - システムガイド

## 概要

このプロジェクトは、カメラ映像を使って赤い旗（ターゲット）を検出し、自動的に追跡する自律移動ロボットの制御システムです。

## システム構成


```
robot_program/
├── roboNavi.py                    # メインプログラム
├── locateTarget.py                # 画像処理・ターゲット検出
├── stateMachine.py                # 状態遷移ロジック
├── ClsDualMotorControl.py         # モーター制御（実機用）
├── ClsDualMotorControlDummy.py    # モーター制御（開発用ダミー）
└── README.md                      # プロジェクト説明
```

---

## 各モジュールの詳細

### 1. roboNavi.py - メインプログラム

ロボット全体の制御を統括するメインループ。

#### 主要な処理フロー

1. **カメラ初期化**: PiCameraで画像取得（640×480ピクセル → 50%にリサイズ）
2. **画像処理**: ターゲット（赤い旗）と敵（緑）を検出
3. **状態判断**: ステートマシンで次の行動を決定
4. **モーター制御**: 決定された行動を実行

#### 動作モード

**モード1: 手動操作モード**
- `u`: 前進（両モーター順方向、デューティ比40）
- `m`: 停止
- `h`: 右旋回（左モーター順、右モーター逆、デューティ比30）
- `k`: 後退（両モーター逆方向、デューティ比40）
- `j`: 左旋回（左モーター逆、右モーター順、デューティ比30）

**モード2: 自動追跡モード**
- カメラで赤い旗を検出し、自動的に追跡
- 旗の位置に応じて前進・左旋回・右旋回を自動選択

#### 主要な関数

```python
def modeSelect(key)
```
キー入力に応じてモード切り替え（'1' or '2'）

```python
def driveRobot(action, myController, duty)
```
状態に応じたモーター制御を実行
- `action`: 状態（IDLE, FORWARD, RIGHT, LEFT）
- `myController`: モーターコントローラーオブジェクト
- `duty`: デューティ比（速度）

---

### 2. locateTarget.py - 画像処理

カメラ画像からターゲットや敵を検出する画像処理モジュール。

#### 関数一覧

**`preprocess(img)`**
- **機能**: 画像の前処理
- **処理内容**:
  - BGR色空間からHSV色空間に変換
  - 3×3のぼかしフィルタで平滑化（ノイズ除去）
- **戻り値**: 前処理済みHSV画像

**`locateFlag(img)`**
- **機能**: 赤い旗の位置とサイズを検出
- **検出方法**:
  - HSV色空間で赤色を抽出
    - 範囲1: H=0-10, S=100-255, V=100-255（赤の低い色相）
    - 範囲2: H=160-180, S=100-255, V=100-255（赤の高い色相）
  - モルフォロジー処理（オープニング）でノイズ除去
  - 縦方向に最も長い赤色領域を検出
- **戻り値**: `(水平位置, 垂直位置, サイズ)`
  - 検出失敗時: `(-1, -1, -1)`

**`locateEnemy(img)`**
- **機能**: 緑色の敵を検出（現在未実装）
- **戻り値**: `(-1, -1, -1)`

#### 色検出のパラメータ

| 色 | 色相(H) | 彩度(S) | 明度(V) |
|---|---------|---------|---------|
| 赤（範囲1） | 0-10 | 100-255 | 100-255 |
| 赤（範囲2） | 160-180 | 100-255 | 100-255 |
| 緑（未実装） | - | - | - |

---

### 3. stateMachine.py - ステートマシン

ロボットの行動を決定する状態遷移ロジック。

#### 状態定義

```python
IDLE = 0      # 待機
FORWARD = 1   # 前進
BACKWARD = 2  # 後退（未使用）
RIGHT = 3     # 右旋回
LEFT = 4      # 左旋回
```

#### 状態遷移ロジック

**`changeState(currentState, flagX, flagY, flagSize)`**

| 現在の状態 | 条件 | 次の状態 |
|-----------|------|---------|
| IDLE | 旗を検出 & サイズ < 80 | FORWARD |
| IDLE | その他 | IDLE |
| FORWARD | 旗を見失った | IDLE |
| FORWARD | サイズ > 80 or < 20 | IDLE |
| FORWARD | 旗が右側（X > 175） | RIGHT |
| FORWARD | 旗が左側（X < 145） | LEFT |
| FORWARD | その他（中央付近） | FORWARD |
| RIGHT/LEFT | 旗を見失った | IDLE |
| RIGHT/LEFT | サイズ > 80 or < 20 | IDLE |
| RIGHT/LEFT | 中心に近い（±5ピクセル以内） | FORWARD |
| RIGHT/LEFT | その他 | RIGHT/LEFT（維持） |

#### パラメータ

- **画像中心**: X=160（320ピクセル幅の半分）
- **中央判定閾値**: ±15ピクセル（145-175の範囲）
- **旋回時の中央判定**: ±5ピクセル（155-165の範囲）
- **適切なサイズ範囲**: 20-80

---

### 4. ClsDualMotorControl.py - モーター制御

Raspberry PiのGPIOを使用してデュアルモーターを制御するクラス。

#### ハードウェア構成

**対応モータードライバ**: TB6612FNG等のデュアルモータードライバ

**GPIO接続**:
```python
vPortsDrive = [23, 22, 25, 9, 10]  # AIN1, AIN2, BIN1, BIN2, STBY
vPortsPWM = [12, 13]               # PWMA, PWMB
```

| ピン | GPIO番号 | 機能 |
|-----|---------|------|
| AIN1 | 23 | モーターA 方向制御1 |
| AIN2 | 22 | モーターA 方向制御2 |
| BIN1 | 25 | モーターB 方向制御1 |
| BIN2 | 9 | モーターB 方向制御2 |
| STBY | 10 | スタンバイ（H:動作, L:停止） |
| PWMA | 12 | モーターA 速度制御（PWM） |
| PWMB | 13 | モーターB 速度制御（PWM） |

#### クラス: ClsDualMotorControl

**初期化**:
```python
myController = ClsDualMotorControl()
```
- GPIO設定（BCMモード）
- PWM初期化（周波数: 50Hz）

**主要メソッド**:

**`driveMotor(vMotor, vDirection, vDuty)`**
- **機能**: 指定したモーターを駆動
- **パラメータ**:
  - `vMotor`: モーター番号（0=左, 1=右）
  - `vDirection`: 方向（0=順方向, 1=逆方向）
  - `vDuty`: デューティ比（0-100、速度を表す）

**`stop()`**
- **機能**: 全モーター停止
- **処理**: PWM停止、全制御ピンをLOWに設定

**`cleanup()`**
- **機能**: GPIO設定をクリーンアップ

#### 動作例

```python
# 前進（両モーター順方向、デューティ比40）
myController.driveMotor(0, 0, 40)  # 左モーター
myController.driveMotor(1, 0, 40)  # 右モーター

# 右旋回（左順、右逆、デューティ比30）
myController.driveMotor(0, 0, 30)  # 左モーター順方向
myController.driveMotor(1, 1, 30)  # 右モーター逆方向

# 停止
myController.stop()
```

---

### 5. ClsDualMotorControlDummy.py - ダミー制御

GPIO非搭載環境（開発PC等）でテストするためのダミークラス。

#### 特徴

- 実際のGPIO制御は行わず、標準出力にログを表示
- `ClsDualMotorControl`と同じインターフェース
- モーター制御ロジックのテストに使用

#### 出力例

```
driveMotor 0 0 40  # モーター0を順方向、デューティ比40で駆動
driveMotor 1 0 40  # モーター1を順方向、デューティ比40で駆動
stop               # 停止
```

---

## 制御フロー全体図

```
[カメラ] → [画像取得] → [HSV変換・平滑化]
                              ↓
                        [赤色領域検出]
                              ↓
                    [旗の位置・サイズ取得]
                              ↓
                      [ステートマシン]
                    (状態判断・遷移)
                              ↓
                ┌─────────────────────┐
                │  IDLE / FORWARD /   │
                │  RIGHT / LEFT       │
                └─────────────────────┘
                              ↓
                      [モーター制御]
                ┌──────────┬──────────┐
                ↓          ↓          ↓
            [前進]     [右旋回]   [左旋回]
```

---

## 使用方法

### 1. 環境準備

```bash
# 必要なライブラリのインストール
sudo apt-get install python3-opencv
sudo apt-get install python3-picamera
sudo apt-get install python3-rpi.gpio
```

### 2. 実機での実行

```bash
# メインプログラムを実行
python3 roboNavi.py
```

### 3. 操作方法

1. プログラム起動後、モードを選択
   - `1`: 手動操作モード
   - `2`: 自動追跡モード

2. 手動モードでのキー操作
   - `u`: 前進
   - `m`: 停止
   - `h`: 右旋回
   - `k`: 後退
   - `j`: 左旋回

3. 自動モードでは、カメラが赤い旗を検出すると自動的に追跡

### 4. 開発環境でのテスト

開発PC等でテストする場合は、`roboNavi.py`のインポート部分を変更:

```python
# 実機用
from ClsDualMotorControl import ClsDualMotorControl

# ↓ダミー用に変更
from ClsDualMotorControlDummy import ClsDualMotorControl
```

---

## パラメータ調整ガイド

### 画像処理の調整

**色検出範囲**（`locateTarget.py`）:
- 照明条件に応じてHSV範囲を調整
- 赤色の検出が不安定な場合: S（彩度）の下限を下げる
- 誤検出が多い場合: S/Vの範囲を狭める

### 状態遷移の調整

**中央判定閾値**（`stateMachine.py`）:
- 旗が中央にあると判定する範囲を変更
- 現在: 145-175（±15ピクセル）
- より正確に追跡: 範囲を狭める（例: ±10ピクセル）
- より安定動作: 範囲を広げる（例: ±20ピクセル）

**サイズ閾値**:
- 適切な距離の範囲を調整
- 現在: 20-80
- より近くで停止: 上限を上げる
- より遠くから追跡開始: 下限を下げる

### モーター制御の調整

**デューティ比**（`roboNavi.py`）:
- 前進速度: 現在40 → 20-60で調整
- 旋回速度: 現在30 → 20-50で調整
- 速すぎる場合: 値を下げる
- 遅すぎる場合: 値を上げる

---

## トラブルシューティング

### カメラが起動しない
- PiCameraが有効化されているか確認: `sudo raspi-config`
- カメラモジュールの接続を確認

### 旗を検出しない
- 照明条件を確認（明るさが不十分/過剰）
- HSV色範囲を調整
- 旗のサイズが小さすぎる場合: カメラを近づける

### モーターが動かない
- GPIO接続を確認
- モータードライバの電源供給を確認
- STBY（スタンバイ）ピンがHIGHになっているか確認

### 追跡が不安定
- デューティ比を下げて速度を落とす
- 状態遷移の閾値を調整
- カメラのフレームレートを確認

---

## 拡張アイデア

1. **敵検出機能の実装**: `locateEnemy()`関数を実装し、緑色の障害物を回避
2. **距離センサーの追加**: 超音波センサー等で障害物検知
3. **複数ターゲット対応**: 複数の旗を順番に訪問
4. **ログ機能**: 状態遷移やセンサー値をファイルに記録
5. **Webインターフェース**: ブラウザから操作・監視

---

## ライセンス・著作権

このプロジェクトの使用・改変については、README.mdを参照してください。

---

## 更新履歴

- 2025-11-07: システムガイド初版作成
